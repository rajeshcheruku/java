name: "CI/CD Pipeline - Build, Scan, Deploy GitHub Gist API"

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: cherukudocker/github-gist-api
  VERSION: ${{ github.run_number }}

jobs:
  sonarcloud_scan:
    name: SonarCloud Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Build with Maven
        run: mvn clean verify -DskipTests=false

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}

  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: sonarcloud_scan

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.VERSION }} .
          docker push ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          docker tag ${{ env.IMAGE_NAME }}:${{ env.VERSION }} ${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.IMAGE_NAME }}:latest

  trivy_scan:
    name: Scan Docker Image with Trivy
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  update_k8s:
    name: Update Deployment YAML with New Tag
    runs-on: ubuntu-latest
    needs: trivy_scan

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Git Config
        run: |
          git config --global user.email "${{ secrets.GIT_EMAIL }}"
          git config --global user.name "${{ secrets.GIT_USERNAME }}"

      - name: Update Deployment Image Tag
        run: |
          sed -i "s|image: cherukudocker/github-gist-api:.*$|image: cherukudocker/github-gist-api:${{ env.VERSION }}|" k8s/deployment.yaml
          echo "${{ env.VERSION }}" > version.txt
          git add k8s/deployment.yaml version.txt
          git commit -m "Updated image tag to version ${{ env.VERSION }}"
          git push
